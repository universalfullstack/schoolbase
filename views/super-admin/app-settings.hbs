<div class="mui-container">

  <!-- Header -->
  <div class="mui--text-headline" style="margin-bottom:24px;">
    <i class="material-icons" style="vertical-align:middle; margin-right:8px;">settings</i>App Settings
  </div>

  {{> flashMessages }}

  <form method="POST" enctype="multipart/form-data">

    <!-- Tabs -->
    <div class="mui-tabs">
      <ul class="mui-tabs__bar">
        <li class="mui--is-active"><a href="#general">General</a></li>
        <li><a href="#branding">Branding</a></li>
        <li><a href="#messaging">Messaging</a></li>
      </ul>

      <!-- ================= GENERAL ================= -->
      <div id="general" class="mui-tabs__pane mui--is-active" style="padding-top:16px;">
        <!-- System Info -->
        <div class="mui-panel" style="margin-bottom:16px;">
          <div class="mui--text-subhead"><i class="material-icons" style="vertical-align:middle; margin-right:4px;">info</i>System Info</div>
          <div class="mui-row" style="margin-top:12px;">
            <div class="mui-col-xs-12 mui-col-md-6" style="margin-bottom:12px;">
              <label for="systemName">System Name</label>
              <input id="systemName" type="text" name="systemName" value="{{settings.general.systemName}}" class="mui-textfield-input">
            </div>
            <div class="mui-col-xs-12 mui-col-md-6" style="margin-bottom:12px;">
              <label for="abbreviation">Abbreviation</label>
              <input id="abbreviation" type="text" name="abbreviation" value="{{settings.general.abbreviation}}" class="mui-textfield-input">
            </div>
          </div>

          <label for="description">Description</label>
          <textarea id="description" name="description" class="mui-textfield-input" style="min-height:80px;">{{settings.general.description}}</textarea>

          <div class="mui-row" style="margin-top:12px;">
            <div class="mui-col-xs-12 mui-col-md-6" style="margin-bottom:12px;">
              <label for="currency">Currency</label>
              <input type="text" id="currency" name="currency" value="{{settings.general.currency}}" class="mui-textfield-input">
            </div>
            <div class="mui-col-xs-12 mui-col-md-6" style="margin-bottom:12px;">
              <label for="timezone">Timezone</label>
              <input type="text" id="timezone" name="timezone" value="{{settings.general.timezone}}" class="mui-textfield-input">
            </div>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="mui-panel">
          <div class="mui--text-subhead"><i class="material-icons" style="vertical-align:middle; margin-right:4px;">contact_mail</i>Contact Info</div>
          <div style="margin-top:12px;">
            <label for="contactEmail">Support Email</label>
            <input id="contactEmail" type="email" name="contactEmail" value="{{settings.contact.email}}" class="mui-textfield-input">

            <label for="contactPhone">Support Phone</label>
            <input id="contactPhone" type="text" name="contactPhone" value="{{settings.contact.phone}}" class="mui-textfield-input">

            <label for="contactAddress">Office Address</label>
            <textarea id="contactAddress" name="contactAddress" class="mui-textfield-input" style="min-height:60px;">{{settings.contact.address}}</textarea>
          </div>
        </div>
      </div>

      <!-- ================= BRANDING ================= -->
      <div id="branding" class="mui-tabs__pane" style="padding-top:16px;">
        <div class="mui-panel">
          <div class="mui--text-subhead"><i class="material-icons" style="vertical-align:middle; margin-right:4px;">palette</i>Branding</div>

          <div class="mui-row" style="margin-top:12px;">
            <!-- Logo -->
            <div class="mui-col-xs-12 mui-col-md-6" style="text-align:center; margin-bottom:16px;">
              <label>Logo</label>
              <div id="logoDropzone" style="width:150px;height:150px;margin:auto; position:relative; display:flex; align-items:center; justify-content:center; cursor:pointer; background:#f0f0f0;">
                <img id="logoPreview" src="{{#if settings.branding.logo}}{{settings.branding.logo}}{{/if}}" style="width:100%;height:100%;object-fit:cover;">
                <div class="overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.25);opacity:0;transition:0.2s;">
                  <i class="material-icons white-text large">photo_camera</i>
                </div>
              </div>
              <input type="file" id="logoInput" name="logo" class="d-none" accept=".png,.jpg,.jpeg">
              <div class="mui--text-dark-secondary" style="font-size:12px;">Recommended: 150x150px</div>
            </div>

            <!-- Favicon -->
            <div class="mui-col-xs-12 mui-col-md-6" style="text-align:center; margin-bottom:16px;">
              <label>Favicon</label>
              <div id="faviconDropzone" style="width:80px;height:80px;margin:auto; position:relative; display:flex; align-items:center; justify-content:center; cursor:pointer; background:#f0f0f0;">
                <img id="faviconPreview" src="{{#if settings.branding.favicon}}{{settings.branding.favicon}}{{/if}}" style="width:100%;height:100%;object-fit:cover;">
                <div class="overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.25);opacity:0;transition:0.2s;">
                  <i class="material-icons white-text large">photo_camera</i>
                </div>
              </div>
              <input type="file" id="faviconInput" name="favicon" class="d-none" accept=".png,.jpg,.jpeg">
              <div class="mui--text-dark-secondary" style="font-size:12px;">Recommended: 80x80px</div>
            </div>
          </div>

          <div class="mui-row">
            <div class="mui-col-xs-12 mui-col-md-6" style="margin-bottom:12px;">
              <label for="primaryColor">Primary Color</label>
              <input type="color" id="primaryColor" name="primaryColor" value="{{settings.branding.primaryColor}}" class="mui-textfield-input">
            </div>
            <div class="mui-col-xs-12 mui-col-md-6" style="margin-bottom:12px;">
              <label for="secondaryColor">Secondary Color</label>
              <input type="color" id="secondaryColor" name="secondaryColor" value="{{settings.branding.secondaryColor}}" class="mui-textfield-input">
            </div>
          </div>
        </div>
      </div>

      <!-- ================= MESSAGING ================= -->
      <div id="messaging" class="mui-tabs__pane" style="padding-top:16px;">
        <div class="mui-panel">
          <div class="mui--text-subhead"><i class="material-icons" style="vertical-align:middle; margin-right:4px;">email</i>Messaging</div>

          <div style="margin-top:12px;">
            <label>Welcome Subject</label>
            <input type="text" name="welcomeSubject" value="{{settings.messaging.general.welcome.subject}}" class="mui-textfield-input">
            <label>Welcome Body</label>
            <textarea name="welcomeBody" class="mui-textfield-input" style="min-height:60px;">{{settings.messaging.general.welcome.body}}</textarea>

            <label>Activation Subject</label>
            <input type="text" name="activationSubject" value="{{settings.messaging.account.activation.subject}}" class="mui-textfield-input">
            <label>Activation Body</label>
            <textarea name="activationBody" class="mui-textfield-input" style="min-height:60px;">{{settings.messaging.account.activation.body}}</textarea>

            <label>Expiry Warning Subject</label>
            <input type="text" name="subscriptionExpirySubject" value="{{settings.messaging.subscription.expiryWarning.subject}}" class="mui-textfield-input">
            <label>Expiry Warning Body</label>
            <textarea name="subscriptionExpiryBody" class="mui-textfield-input" style="min-height:60px;">{{settings.messaging.subscription.expiryWarning.body}}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:16px;">
      <button type="submit" class="mui-btn mui-btn--primary">
        <i class="material-icons" style="vertical-align:middle; margin-right:4px;">save</i>Save Settings
      </button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize MUI Tabs
  const tabs = document.querySelectorAll('.mui-tabs');
  tabs.forEach(tabContainer => {
    const links = tabContainer.querySelectorAll('.mui-tabs__bar a');
    links.forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        links.forEach(l => l.parentElement.classList.remove('mui--is-active'));
        links.forEach(l => {
          const paneId = l.getAttribute('href').substring(1);
          tabContainer.querySelector('#' + paneId).classList.remove('mui--is-active');
        });
        link.parentElement.classList.add('mui--is-active');
        const targetPaneId = link.getAttribute('href').substring(1);
        tabContainer.querySelector('#' + targetPaneId).classList.add('mui--is-active');
      });
    });
  });

  function setupImageDropzone(dropzoneId, inputId, previewId) {
    const dropzone = document.getElementById(dropzoneId);
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const overlay = dropzone.querySelector('.overlay');

    dropzone.addEventListener('click', () => input.click());
    dropzone.addEventListener('mouseenter', () => overlay.style.opacity = 1);
    dropzone.addEventListener('mouseleave', () => overlay.style.opacity = 0);

    input.addEventListener('change', e => {
      const file = e.target.files[0];
      if(file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => preview.src = e.target.result;
        reader.readAsDataURL(file);
      }
    });

    dropzone.addEventListener('dragover', e => { e.preventDefault(); overlay.style.opacity = 1; });
    dropzone.addEventListener('dragleave', e => { e.preventDefault(); overlay.style.opacity = 0; });
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      overlay.style.opacity = 0;
      const file = e.dataTransfer.files[0];
      if(file && file.type.startsWith('image/')) {
        input.files = e.dataTransfer.files;
        const reader = new FileReader();
        reader.onload = e => preview.src = e.target.result;
        reader.readAsDataURL(file);
      }
    });
  }

  setupImageDropzone('logoDropzone', 'logoInput', 'logoPreview');
  setupImageDropzone('faviconDropzone', 'faviconInput', 'faviconPreview');
});
</script>
