<div class="dashboard-page">

  <!-- Greeting -->
  <div class="section">
    <h4>{{user.role}} Dashboard</h4>

    {{#unless user.emailVerified}}
      <div class="card-panel yellow lighten-4 black-text">
        <i class="material-icons left">warning</i>
        Email not verified
      </div>
    {{/unless}}
  </div>

  <!-- ================= STATS ================= -->
  <div class="row">

    <div class="col s12 m6 l3">
      <div class="card blue darken-2 white-text">
        <div class="card-content">
          <span class="card-title">Schools</span>
          <h5>{{stats.totalSchools}}</h5>
        </div>
      </div>
    </div>

    <div class="col s12 m6 l3">
      <div class="card amber darken-2 white-text">
        <div class="card-content">
          <span class="card-title">School Admins</span>
          <h5>{{stats.totalSchoolAdmins}}</h5>
        </div>
      </div>
    </div>

    <div class="col s12 m6 l3">
      <div class="card purple darken-1 white-text">
        <div class="card-content">
          <span class="card-title">Staff</span>
          <h5>{{stats.totalStaff}}</h5>
        </div>
      </div>
    </div>

    <div class="col s12 m6 l3">
      <div class="card teal lighten-1 white-text">
        <div class="card-content">
          <span class="card-title">Students</span>
          <h5>{{stats.totalStudents}}</h5>
        </div>
      </div>
    </div>

    <div class="col s12 m6 l3">
      <div class="card green darken-2 white-text">
        <div class="card-content">
          <span class="card-title">Active Subscriptions</span>
          <h5>{{stats.totalSubscriptions}}</h5>
        </div>
      </div>
    </div>

    <div class="col s12 m6 l3">
      <div class="card teal darken-2 white-text">
        <div class="card-content">
          <span class="card-title">Total Revenue</span>
          <h5>â‚¦{{stats.totalRevenue}}</h5>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= CHARTS ================= -->
  <div class="row">

    <div class="col s12 l6">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Subscription Trend (Last 6 Months)</span>
          <div class="chart-box">
            <canvas id="subscriptionTrendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col s12 l6">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Subscriptions by Status</span>
          <div class="chart-box">
            <canvas id="subscriptionStatusChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= LATEST SUBSCRIPTIONS ================= -->
  <div class="card">
    <div class="card-content">
      <span class="card-title">Latest Subscriptions</span>

      <table class="highlight responsive-table">
        <thead>
          <tr>
            <th>School</th>
            <th>Plan</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
          </tr>
        </thead>

        <tbody>
          {{#each latestSubscriptions}}
          <tr>
            <td>{{this.school}}</td>
            <td>{{this.plan}}</td>
            <td>{{this.startDate}}</td>
            <td>{{this.endDate}}</td>
            <td>
              {{#if (eq this.status "active")}}
                <span class="new badge green" data-badge-caption="">Active</span>
              {{else if (eq this.status "expired")}}
                <span class="new badge red" data-badge-caption="">Expired</span>
              {{else if (eq this.status "pending")}}
                <span class="new badge amber black-text" data-badge-caption="">Pending</span>
              {{else}}
                <span class="new badge grey" data-badge-caption="">Cancelled</span>
              {{/if}}
            </td>
          </tr>
          {{else}}
          <tr>
            <td colspan="5" class="center grey-text">No subscriptions yet</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- ================= PAGE STYLES ================= -->
{{#section "styles"}}
<style>
  .chart-box {
    position: relative;
    height: 300px;
  }

  canvas {
    width: 100% !important;
    height: 100% !important;
  }
</style>
{{/section}}

<!-- ================= PAGE SCRIPTS ================= -->
{{#section "scripts"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const trendLabels  = {{{trendLabels}}};
  const trendData    = {{{trendData}}};
  const statusLabels = {{{statusLabels}}};
  const statusData   = {{{statusData}}};

  // Line Chart
  new Chart(document.getElementById('subscriptionTrendChart'), {
    type: 'line',
    data: {
      labels: trendLabels,
      datasets: [{
        label: 'New Subscriptions',
        data: trendData,
        backgroundColor: 'rgba(33, 150, 243, 0.2)',
        borderColor: '#2196f3',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Doughnut Chart
  new Chart(document.getElementById('subscriptionStatusChart'), {
    type: 'doughnut',
    data: {
      labels: statusLabels.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
      datasets: [{
        data: statusData,
        backgroundColor: ['#2e7d32', '#c62828', '#f9a825', '#757575']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

});
</script>
{{/section}}
